#!/bin/bash
# Startup script for {{ service_name }}
# Generated by Rustle Deploy

SERVICE_NAME="{{ service_name }}"
LOG_LEVEL="{{ log_level | upper }}"
WORKERS={{ workers }}
MEMORY_LIMIT="{{ memory_limit }}"

{% if enable_monitoring %}
# Enable monitoring
export ENABLE_MONITORING=true
export METRICS_PORT=9090
{% else %}
# Monitoring disabled
export ENABLE_MONITORING=false
{% endif %}

# Set environment variables
export LOG_LEVEL=$LOG_LEVEL
export WORKERS=$WORKERS
export MEMORY_LIMIT=$MEMORY_LIMIT

# Create necessary directories
mkdir -p /var/log/$SERVICE_NAME
mkdir -p /var/run/$SERVICE_NAME

{% if log_level == "debug" %}
# Debug mode - verbose output
set -x
{% endif %}

# Start the service
echo "Starting $SERVICE_NAME with $WORKERS workers..."
echo "Memory limit: $MEMORY_LIMIT"
echo "Log level: $LOG_LEVEL"

{% for i in range(workers) %}
# Worker {{ i + 1 }}
nohup /usr/local/bin/$SERVICE_NAME-worker \
    --worker-id={{ i + 1 }} \
    --log-level=$LOG_LEVEL \
    > /var/log/$SERVICE_NAME/worker-{{ i + 1 }}.log 2>&1 &
{% endfor %}

# Save PIDs
jobs -p > /var/run/$SERVICE_NAME/workers.pid

echo "$SERVICE_NAME started successfully"